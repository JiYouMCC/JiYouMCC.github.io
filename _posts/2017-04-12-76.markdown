---
layout: post
title:  "悬挂目录Affix table of contents"
date:   2017-04-12 09:25:00 +0800
categories: 技术
tags: javascript jquery bootstrapt
use_code: true
---
这个东西其实在django版本的时候我已经弄过了，但是在各种博客的迁移过程中没有一起搬上来

现在放在这里主要是记录一些代码，万一以后还要搬迁呢

<!--more-->

首先是关于查找所有header的部分，最初版本来自于sinaapp的django版本

当然很多element的id都变了

里面取位置主要还是用了outerHeight

最后body上安放监控居然是用add attr（我也不知道当时是怎么想的）

Sinaapp\gutools\1\static\js\blog_post.js：

    $('#affix-nav').affix({
      offset: {
        top: function() {
          return (this.top = $('#top').outerHeight(true) + $('#right_standard').outerHeight(true));
        },
        bottom: function() {
          return (this.bottom = $('#bottom').outerHeight(true) + 20);
        }
      }
    })

    $('.affix-top').width($('#right_standard').width());
    $('.affix').width($('#right_standard').width());

    $(window).resize(function() {
      $('.affix').width($('#right_standard').width());
    });

    $(window).scroll(function() {
      $('.affix').width($('#right_standard').width());
    });


    var headers = $("#blog_content").find("h1,h2,h3,h4,h5,h6");
    var maxHead = 6;
    for (var i = 0; i < headers.length; i++) {
      var currentHead = parseInt(headers[i].tagName[1]);
      if (currentHead < maxHead) {
        maxHead = currentHead;
      }
    }

    var links = $("<ol></ol>")
      .attr("id", "affix-nav-ul")
      .attr("class", "nav nav-stacked")
      .attr("role", "tablist");
    links.append(
      $("<li></li").append(
        $("<a></a>").attr("href", "#top").append(
          $("<span></span>").attr("class", "glyphicon glyphicon-triangle-top")
        )
      )
    );

    var currentParent = links;
    var lastLi = null;
    var currentClass = maxHead;

    for (var i = 0; i < headers.length; i++) {
      var currentHead = parseInt(headers[i].tagName[1]);
      if (currentHead > currentClass) {
        while (currentHead > currentClass) {
          var newUl = $("<ol></ol>");
          if (lastLi != null){
            lastLi.append(newUl)
          } else {
            currentParent.append(newUl);
          }
          currentClass += 1;
          currentParent = newUl;
        }
      } else if (currentHead < currentClass) {
        while (currentHead < currentClass) {
          currentClass -= 1;
          currentParent = currentParent.parent().parent();
        }
      }
      lastLi = $("<li></li").append($("<a></a>").attr("href", "#" + headers[i].id).text($(headers[i]).text()));
      currentParent.append(lastLi);
    }

    links.append(
      $("<li></li").append(
        $("<a></a>").attr("href", "#bottom").append(
          $("<span></span>").attr("class", "glyphicon glyphicon-triangle-bottom")
        )
      )
    );

    $("#links").append(links);
    $("body").attr("data-spy", "scroll");
    $("body").attr("data-target", "#affix-nav");

然后是[养龙结婚证的数据页面](http://fr.jithee.name/data.html)上用的代码：

同样也是body加attr的方式开始滚动监控

不过养龙因为标题都是h4而且是半静态的页面，所以简单很多

    $("body").attr("data-spy", "scroll");
    $("body").attr("data-target", "#affix-nav");
    for (var i = 0; i < $("h4").length; i++) {
        $($("h4")[i]).attr("id", "title_" + i);
        var text = $($("h4")[i]).text();
        $("<li></li>").append(
                $("<a></a>")
                .attr("href", "#title_" + i)
                .attr("data-localize", text)
                .text(text)
            )
            .attr("data-toggle", "tooltip")
            .attr("data-placement", "text")
            .insertBefore('#nav_bottom');
    }

    $('#affix-nav').affix({
        offset: {
            top: function() {
                return (this.top = $('#top').outerHeight(true));
            },
            bottom: function() {
                return (this.bottom = $('#bottom').outerHeight(true) + 20);
            }
        }
    })

    $('.affix-top').width($('#stand').width());
    $('.affix').width($('#stand').width());

    $(window).resize(function() {
        $('.affix').width($('#stand').width());
    });

    $(window).scroll(function() {
        $('.affix').width($('#stand').width());
    });

接着是affix相关的css，django版本的时候就写了的

关于缩进的部分写的好烂啊哈哈哈……

    .affix {
      top: 20px;
    }

    .affix-bottom{
      position: absolute;
    }

    #affix-nav-ul ol{
      padding-left: 0px;
    }

    #affix-nav-ul li{
        position: relative;
        display: block;
        margin: 0px;
        background-color: #e9f0f6;
        padding: 0px;
        overflow:hidden;
    }

    #affix-nav-ul li > a {
        position: relative;
        display: block;
        padding: 10px 15px;
        white-space: nowrap;
        border-top: 1px solid #a1afc9;
    }

    #affix-nav-ul > li:first-child {
        border-top-right-radius: 4px;
        border-top-left-radius: 4px;
    }

    #affix-nav-ul > li:first-child > a {
        border-top-width: 0;
    }

    #affix-nav-ul > li:last-child {
        margin-bottom: 0px;
        border-bottom-width: 0;
        border-bottom-right-radius: 4px;
        border-bottom-left-radius: 4px;
    }

    #affix-nav-ul li.active > a, 
    #affix-nav-ul li.active > a:hover, 
    #affix-nav-ul li.active > a:focus {
      color: #161824;
      text-shadow: 1px 1px 1px #88ada6;
      font-weight: bold;
    }

    #affix-nav-ul > li > ol > li > a {
      padding-left: 25px;
    }

    #affix-nav-ul > li > ol > li > ol > li > a {
      padding-left: 35px;
    }

    #affix-nav-ul > li > ol > li > ol > li > ol > li > a {
      padding-left: 45px;
    }

    #affix-nav-ul > li > ol > li > ol > li > ol > li > ol > li > a {
      padding-left: 55px;
    }

    #affix-nav-ul > li > ol > li > ol > li > ol > li > ol > li > ol > li > a {
      padding-left: 65px;
    }

    #affix-nav-ul li > ol > li {
        display: none;
    }

    #affix-nav-ul li[class|=active] > ol > li {
        display: initial;
    }
    
目前版本的：

https://github.com/JiYouMCC/JiYouMCC.github.io/blob/master/js/affix.js

我也没想明白为什么突然就用offset().top了。。

其实我还想加个scrollto的效果，回头再说了

    $(function() { 
      $('#affix-nav').affix({
        offset: {
          top: function() {
            return $('#rss_nav').offset().top + $('#affix-nav-ul').height() + 20;
          },
          bottom: function() {
            return $('#bottom').outerHeight(true) + 20;
          }
        }
      });
      $('#affix-nav').width($('#rss_nav').width());
      $(window).resize(function () {
        $('#affix-nav').width($('#rss_nav').width());
      });
    });

    var headers = $("#blog_content").find("h1,h2,h3,h4,h5,h6");
    var maxHead = 6;
    for (var i = 0; i < headers.length; i++) {
      $(headers[i]).attr("data-localize", $(headers[i]).text());
      var currentHead = parseInt(headers[i].tagName[1]);
      if (currentHead < maxHead) {
        maxHead = currentHead;
      }
    }

    var links = $("<ol></ol>").attr("id", "affix-nav-ul").attr("class", "nav nav-stacked").attr("role", "tablist");

    links.append(
      $("<li></li").append(
        $("<a></a>").attr('href', '#top').append(
          $("<span></span>").attr("class", "glyphicon glyphicon-triangle-top")
        )
      )
    );

    var currentParent = links;
    var lastLi = null;
    var currentClass = maxHead;

    for (var i = 0; i < headers.length; i++) {
      var currentHead = parseInt(headers[i].tagName[1]);
      if (currentHead > currentClass) {
        while (currentHead > currentClass) {
          var newUl = $("<ol></ol>").addClass("nav").addClass("nav-stacked");
          if (lastLi != null){
            lastLi.append(newUl)
          } else {
            currentParent.append(newUl);
          }  

          currentClass += 1;
          currentParent = newUl;
        }
      } else if (currentHead < currentClass) {
        while (currentHead < currentClass) {
          currentClass -= 1;
          currentParent = currentParent.parent().parent();
        }
      } 

      lastLi = $("<li></li>").append(
        $("<a></a>").attr("href", "#" + headers[i].id).attr("data-localize", $(headers[i]).text()).text($(headers[i]).text())
      );
      currentParent.append(lastLi);
    }

    links.append(
      $("<li></li").append(
        $("<a></a>").attr('href', '#bottom').append(
          $("<span></span>").attr("class", "glyphicon glyphicon-triangle-bottom")
        )
      )
    );

    $("#affix-nav-pannel").append(links);
    $('body').scrollspy({ target: '#affix-nav-pannel' })
