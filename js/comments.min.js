Comments={_auth:void 0,_sync:void 0,_timestamp:void 0,init:function(e,n){if("firebase"==e)firebase.initializeApp(n),Comments._auth=firebase.auth(),Comments._sync=firebase.database(),Comments._timestamp=firebase.database.ServerValue.TIMESTAMP
else if("wilddog"==e){var o=wilddog.initializeApp(n)
Comments._auth=o.auth(),Comments._sync=o.sync(),Comments._timestamp=o.sync().ServerValue.TIMESTAMP}},handleError:function(e){console.log(e)},formatDate:function(e){return e.getFullYear()+"-"+("0"+(e.getMonth()+1)).slice(-2)+"-"+("0"+e.getDate()).slice(-2)+" "+("0"+e.getHours()).slice(-2)+":"+("0"+e.getMinutes()).slice(-2)+":"+("0"+e.getSeconds()).slice(-2)+" "},errors:{NO_POST:"没有指定文章",NO_NAME:"昵称为空",NAME_TOO_LONG:"昵称太长",NO_EMAIL:"邮件地址为空",EMAIL_INVALD:"邮件地址无效",URL_INVALD:"网址无效",NO_COMMENT:"评论为空",COMMENT_TOO_LONG:"评论太长",NO_COUNT:"没有指定数量"},handleCallback:function(e,n){e&&e(n)},_convertDicToSortedArray:function(e){var n=[]
for(commentId in e){var o=e[commentId]
o.id=commentId,n.push(o)}return n.sort(function(e,n){return e.timestamp>n.timestamp}),n},comment:{list:function(e,n){e?Comments._sync.ref("/comments").orderByChild("post").equalTo(e).once("value",function(e){Comments.handleCallback(n,Comments._convertDicToSortedArray(e.val()))}):(Comments.handleError(Comments.errors.NO_POST),Comments.handleCallback(n,void 0))},listCallback:function(e,n){if(e){var o=Comments._sync.ref("/comments").orderByChild("post").equalTo(e)
return o.on("value",function(e){Comments.handleCallback(n,Comments._convertDicToSortedArray(e.val()))}),o}Comments.handleError(Comments.errors.POSTID_CAN_NOT_BLANK),Comments.handleCallback(n,void 0)},add:function(e,n,o,t,m,a,r){return e?e.length>20?(Comments.handleError(Comments.errors.NAME_TOO_LONG),void Comments.handleCallback(r,!1)):n?/^[\.a-zA-Z0-9_-]+@[a-zA-Z0-9_-]+(\.[a-zA-Z0-9_-]+)+$/.test(n)?o?m&&!/^https?:\/\/(www\.)?[-a-zA-Z0-9@:%._\+~#=]{2,256}\.[a-z]{2,6}\b([-a-zA-Z0-9@:%_\+.~#?&\/\/=]*)$/.test(m)?(Comments.handleError(Comments.errors.URL_INVALD),void Comments.handleCallback(r,!1)):t?t.length>=2048?(Comments.handleError(Comments.errors.COMMENT_TOO_LONG),void Comments.handleCallback(r,!1)):void Comments.post.commentCount.get(o,function(s){var l=Comments._sync.ref("/comments")
l.push({name:e,email:n,post:o,timestamp:Comments._timestamp,comment:t,url:m?m:null,reply:a?a:null},function(e){e?(Comments.handleError(e),Comments.handleCallback(r,!1)):Comments.post.commentCount.set(o,s.count+1,function(){Comments.handleCallback(r,!0)})})}):(Comments.handleError(Comments.errors.NO_COMMENT),void Comments.handleCallback(r,!1)):(Comments.handleError(Comments.errors.NO_POST),void Comments.handleCallback(r,!1)):(Comments.handleError(Comments.errors.EMAIL_INVALD),void Comments.handleCallback(r,!1)):(Comments.handleError(Comments.errors.NO_EMAIL),void Comments.handleCallback(r,!1)):(Comments.handleError(Comments.errors.NO_NAME),void Comments.handleCallback(r,!1))},recent:{_callback:void 0,get:function(e,n){e=e?e:10,Comments._sync.ref("/comments").orderByChild("timestamp").limitToLast(e).once("value",function(e){Comments.handleCallback(n,Comments._convertDicToSortedArray(e.val()))})},updateCallback:function(e,n){Comments.comment.recent.removeCallback(),Comments.comment._callback=Comments._sync.ref("/comments").orderByChild("timestamp").limitToLast(e),Comments.comment._callback.on("value",function(e){Comments.handleCallback(n,Comments._convertDicToSortedArray(e.val()))})},removeCallback:function(){Comments.comment._callback&&(Comments.comment._callback.remove(),Comments.comment._callback=void 0)}},convertFromDuoshuo:function(e){for(var e=JSON.parse(e),n={comments:{}},o=n.comments,t=0;t<e.posts.length;t++){var m=e.posts[t],a={}
a.name=m.author_name,a.email=m.author_email,m.author_url&&(a.url=m.author_url),a.post=m.thread_key,a.timestamp=parseInt(new Date(m.created_at).getTime()),a.comment=m.message,o[m.post_id]=a}return n},transferFromDuoShuo:function(e,n){var o=Comments.comment.convertFromDuoshuo(e)
Comments._sync.ref("/comments").update(o.comments,function(e){e?(Comments.handleError(e),Comments.handleCallback(n,!1)):Comments.post.commentCount.check(function(e){e&&Comments.handleCallback(n,!0)})})}},post:{commentCount:{get:function(e,n){return e?void Comments._sync.ref("/posts/"+e).once("value",function(o){var t=0
o&&o.val()&&o.val().count&&(t=o.val().count),Comments.handleCallback(n,{post:e,count:t})}):(Comments.handleError(Comments.errors.NO_POST),void Comments.handleCallback(n,null))},set:function(e,n,o){return e?n?void Comments._sync.ref("/posts/"+e).set({count:n},function(e){e?(Comments.handleError(e),Comments.handleCallback(o,!1)):Comments.handleCallback(o,!0)}):(Comments.handleError(Comments.errors.NO_COUNT),void Comments.handleCallback(o,!1)):(Comments.handleError(Comments.errors.NO_POST),void Comments.handleCallback(o,!1))},updateCallback:function(e,n){if(!e)return Comments.handleError(Comments.errors.NO_POST),void Comments.handleCallback(n,null)
var o=Comments._sync.ref("/posts/"+e)
return o.on("value",function(o){var t=0
o&&o.val()&&o.val().count&&(t=o.val().count),Comments.handleCallback(n,{post:e,count:t})}),o},check:function(e){Comments._sync.ref("/comments").once("value",function(n){if(!n)return Comments.handleCallback(e,!1),!0
var o=n.val(),t={}
for(commentId in o){for(var m=o[commentId],a=m.post.split("/"),r=0;r<a.length;){var s=a[r]
""==s?a.splice(r,1):r++}for(var l=t,r=0;r<a.length;r++){var s=a[r].toString()
l[s]||(l[s]={}),l=l[s]}l.count?l.count=l.count+1:l.count=1}Comments._sync.ref("/posts").set(t,function(n){n?(Comments.handleError(n),Comments.handleCallback(e,!1)):Comments.handleCallback(e,!0)})})}}}}
