var OldComments = {
  "data": {
    "comments": {
      "-Kgd2r71djaLSZfQ9Jre": {
        "comment": "不用注册真是太棒了……\n\n不过是不是也没有评论回复邮件了 = =",
        "email": "ip.192.168.1.1@qq.com",
        "name": "oott123",
        "post": "/blog/post/75",
        "timestamp": 1491042529796
      },
      "-Kgd2uj5dIvHUQhQ83tD": {
        "comment": "这是一条嵌套回复测试。",
        "email": "ip.192.168.1.1@qq.com",
        "name": "oott123",
        "post": "/blog/post/75",
        "reply": "-Kgd2r71djaLSZfQ9Jre",
        "timestamp": 1491042544518
      },
      "-Kgd2wr9VFEMaaAIXam0": {
        "comment": "这是嵌套嵌套回复测试",
        "email": "ip.192.168.1.1@qq.com",
        "name": "oott123",
        "post": "/blog/post/75",
        "reply": "-Kgd2uj5dIvHUQhQ83tD",
        "timestamp": 1491042553228
      },
      "-Kgd2yOaqRUMKLsRyfom": {
        "comment": "好吧不能盖楼",
        "email": "ip.192.168.1.1@qq.com",
        "name": "oott123",
        "post": "/blog/post/75",
        "reply": "-Kgd2wr9VFEMaaAIXam0",
        "timestamp": 1491042559522
      },
      "-Kgd39rff4O6wI2JZpXb": {
        "comment": "邮件什么的我可以继续弄\n又发现一个问题，前端input应该输入一下cookie值，回头再弄了",
        "email": "nightghostjiyou@gmail.com",
        "name": "嵇尔",
        "post": "/blog/post/75",
        "reply": "-Kgd2uj5dIvHUQhQ83tD",
        "timestamp": 1491042611571
      },
      "-Kgd3UmLMECkk4N1dOz6": {
        "comment": "盖楼模式什么，查看对话什么的，都好说，都是前端",
        "email": "nightghostjiyou@gmail.com",
        "name": "嵇尔",
        "post": "/blog/post/75",
        "reply": "-Kgd2yOaqRUMKLsRyfom",
        "timestamp": 1491042697270
      },
      "-KgdAqFe6yIQP2whZSMK": {
        "comment": "👏，我得多学学才能搞定复用，现在只能硬 coding😢\n评论就让它保持简单就好，太复杂的事情也不太可能采用评论的方式\n**这个 UI 确实不咋滴**😜",
        "email": "flinhong@hotmail.com",
        "name": "Frank Lin",
        "post": "/blog/post/75",
        "timestamp": 1491044623862,
        "url": "https://flinhong.com"
      },
      "-KgdFES-CBJnJEdPC89w": {
        "comment": "复用什么的整理代码，提成函数方法，提着提着就变成库了😃",
        "email": "nightghostjiyou@gmail.com",
        "name": "嵇尔",
        "post": "/blog/post/75",
        "reply": "-KgdAqFe6yIQP2whZSMK",
        "timestamp": 1491045775805
      },
      "-KgdS1jgY46xTX7VERW3": {
        "comment": "嗯，觉着挺复杂，怕自己弄不好不好调试，目前看过的唯一一本 js 书就是 dom scripting，往后多练习了。\n没想到 emoji 斜体是这个样子的哟",
        "email": "flinhong@hotmail.com",
        "name": "Frank Lin",
        "post": "/blog/post/75",
        "reply": "-KgdFES-CBJnJEdPC89w",
        "timestamp": 1491049131779,
        "url": "https://flinhong.com"
      },
      "-KhWiOqG5eDgoQxJ4Xm7": {
        "comment": "弄这个的时候，我也改了蛮久CSS",
        "email": "flinhong@hotmail.com",
        "name": "Frank Lin",
        "post": "/blog/post/76",
        "timestamp": 1491993206469,
        "url": "https://flinhong.com"
      },
      "-KhXC7uy0RQMXGIbOw0v": {
        "comment": "CSS还好，因为我主要还是用bootstrapt框架，稍微加点自己的主题\n反倒是算header我记得当时写了很久，结果现在都不想检查写得对不对……",
        "email": "nightghostjiyou@gmail.com",
        "name": "嵇尔",
        "post": "/blog/post/76",
        "reply": "-KhWiOqG5eDgoQxJ4Xm7",
        "timestamp": 1492001264122
      },
      "-KvSXeydvo7_H-xiAVJR": {
        "comment": "哇！草草姐怀孕啦！恭喜恭喜~",
        "email": "ip.192.168.1.1@qq.com",
        "name": "oott123",
        "post": "/blog/post/80",
        "timestamp": 1506955407759,
        "url": "https://best33.com"
      },
      "-KvzGN7bdj69NhaP0N6H": {
        "comment": "偷偷在家里孵蛋呢……",
        "email": "nightghostjiyou@gmail.com",
        "name": "嵇尔",
        "post": "/blog/post/80",
        "reply": "-KvSXeydvo7_H-xiAVJR",
        "timestamp": 1507521299419,
        "url": "http://www.jithee.name"
      },
      "6347170250093495042": {
        "comment": "果然记录一下看着很有意思呢！！",
        "email": "unadust@yeah.net",
        "name": "夜空",
        "post": "/blog/post/32",
        "timestamp": 1448375966000
      },
      "6347170250248684289": {
        "comment": "我居然没想到用eval。。。这个是好东西。。\n递归思路也不错。。。。代码比我简洁多了\n我第一想法还是排列组合。。",
        "email": "nightghostjiyou@gmail.com",
        "name": "嵇尔",
        "post": "/blog/post/26",
        "reply": "6347170251406312194",
        "timestamp": 1442981618000
      },
      "6347170250911384321": {
        "comment": "丑得无以复加的邮件……",
        "email": "nightghostjiyou@gmail.com",
        "name": "嵇尔",
        "post": "/blog/post/18",
        "timestamp": 1425795044000
      },
      "6347170251045602049": {
        "comment": "再来一封",
        "email": "nightghostjiyou@gmail.com",
        "name": "嵇尔",
        "post": "/blog/post/18",
        "timestamp": 1425794883000
      },
      "6347170251184014081": {
        "comment": "骚扰邮件",
        "email": "nightghostjiyou@gmail.com",
        "name": "嵇尔",
        "post": "/blog/post/18",
        "timestamp": 1425794679000
      },
      "6347170251406312194": {
        "comment": "result = []\n\ndef f(n, eq):\n    if n == 10:\n        if eval(eq) == 100:\n            result.append(eq + \"=100\")\n        return\n    print eq\n    f(n + 1, eq + '+' + str(n))  #1\n    f(n + 1, eq + '-' + str(n))  #2\n    f(n + 1, eq + str(n))   #3\n\nf(2, '1')\n\nfor m in result:\n    print m",
        "email": "cdx_net@com",
        "name": "cdx",
        "post": "/blog/post/26",
        "timestamp": 1442908496000
      },
      "6347170251548918529": {
        "comment": "前面注册用户带回复，我让不注册的也能回复了，前几天域名刚下来，我明天去整整sendcloud，新浪自带的不让改标题啥的不爽",
        "email": "nightghostjiyou@gmail.com",
        "name": "嵇尔",
        "post": "/blog/post/18",
        "timestamp": 1425656682000
      },
      "6347170251691524865": {
        "comment": "咦！刚刚还没有回复的！",
        "email": "ip.192.168.1.1@qq.com",
        "name": "oott123",
        "post": "/blog/post/18",
        "timestamp": 1425656589000
      },
      "6347170251813159682": {
        "comment": "Mailgun 或者 SendCloud 都挺好的，不过一天一百封还不够么，你前台又没回复功能……",
        "email": "ip.192.168.1.1@qq.com",
        "name": "oott123",
        "post": "/blog/post/18",
        "timestamp": 1425656561000
      },
      "6347170251985126145": {
        "comment": "我去，新浪云一天只让100封邮件，发不了多少啊。。。我在找邮件第三方api中。。文泉亿微米黑比正黑好多了，至少i和l认得出区别",
        "email": "nightghostjiyou@gmail.com",
        "name": "嵇尔",
        "post": "/blog/post/18",
        "timestamp": 1425656079000
      },
      "6347170252115149570": {
        "comment": "session 不幸福 回复评论没有邮件通知不幸福 验证码有 o 0 l 1 I 不幸福",
        "email": "ip.192.168.1.1@qq.com",
        "name": "oott123",
        "post": "/blog/post/18",
        "timestamp": 1425655911000
      },
      "6347170252253561602": {
        "comment": "后台还没写好呢，我刚刚把前台的form改了而已，后台在验证码图片上划线中……",
        "email": "nightghostjiyou@gmail.com",
        "name": "嵇尔",
        "post": "/blog/post/18",
        "timestamp": 1425628055000
      },
      "6347170252375196417": {
        "comment": "卧槽验证码随便写就过了啊这也太随便了吧！",
        "email": "ip.192.168.1.1@qq.com",
        "name": "三三",
        "post": "/blog/post/18",
        "timestamp": 1425624770000
      },
      "6347170252505219842": {
        "comment": "就是百度站长工具干的，都是一些常用的 payload 而已……",
        "email": "ip.192.168.1.1@qq.com",
        "name": "三三",
        "post": "/blog/post/18",
        "timestamp": 1425624753000
      }
    },
    "posts": {
      "blog": {
        "post": {
          "18": {
            "count": 11
          },
          "26": {
            "count": 2
          },
          "32": {
            "count": 1
          },
          "75": {
            "count": 9
          },
          "76": {
            "count": 2
          },
          "80": {
            "count": 2
          }
        }
      }
    }
  },
  GetCommentsCount: function(postId) {
    return OldComments.GetComments(postId).length;
  },
  GetComments: function(postId) {
    var result = [];
    for (commentID in OldComments.data.comments) {
      var comment = OldComments.data.comments[commentID];
      if (comment.post == postId) {
        comment["id"] = commentID;
        result.push(comment);
      }
    }
    return result;
  },
  getGravatar: function(email, size) {
    return "https://www.gravatar.com/avatar/" + OldComments.MD5(email) + "?s=" + size;
  },
  MD5: function(s) {
    function L(k, d) {
      return (k << d) | (k >>> (32 - d))
    }

    function K(G, k) {
      var I, d, F, H, x;
      F = (G & 2147483648);
      H = (k & 2147483648);
      I = (G & 1073741824);
      d = (k & 1073741824);
      x = (G & 1073741823) + (k & 1073741823);
      if (I & d) {
        return (x ^ 2147483648 ^ F ^ H)
      }
      if (I | d) {
        if (x & 1073741824) {
          return (x ^ 3221225472 ^ F ^ H)
        } else {
          return (x ^ 1073741824 ^ F ^ H)
        }
      } else {
        return (x ^ F ^ H)
      }
    }

    function r(d, F, k) {
      return (d & F) | ((~d) & k)
    }

    function q(d, F, k) {
      return (d & k) | (F & (~k))
    }

    function p(d, F, k) {
      return (d ^ F ^ k)
    }

    function n(d, F, k) {
      return (F ^ (d | (~k)))
    }

    function u(G, F, aa, Z, k, H, I) {
      G = K(G, K(K(r(F, aa, Z), k), I));
      return K(L(G, H), F)
    }

    function f(G, F, aa, Z, k, H, I) {
      G = K(G, K(K(q(F, aa, Z), k), I));
      return K(L(G, H), F)
    }

    function D(G, F, aa, Z, k, H, I) {
      G = K(G, K(K(p(F, aa, Z), k), I));
      return K(L(G, H), F)
    }

    function t(G, F, aa, Z, k, H, I) {
      G = K(G, K(K(n(F, aa, Z), k), I));
      return K(L(G, H), F)
    }

    function e(G) {
      var Z;
      var F = G.length;
      var x = F + 8;
      var k = (x - (x % 64)) / 64;
      var I = (k + 1) * 16;
      var aa = Array(I - 1);
      var d = 0;
      var H = 0;
      while (H < F) {
        Z = (H - (H % 4)) / 4;
        d = (H % 4) * 8;
        aa[Z] = (aa[Z] | (G.charCodeAt(H) << d));
        H++
      }
      Z = (H - (H % 4)) / 4;
      d = (H % 4) * 8;
      aa[Z] = aa[Z] | (128 << d);
      aa[I - 2] = F << 3;
      aa[I - 1] = F >>> 29;
      return aa
    }

    function B(x) {
      var k = "",
        F = "",
        G, d;
      for (d = 0; d <= 3; d++) {
        G = (x >>> (d * 8)) & 255;
        F = "0" + G.toString(16);
        k = k + F.substr(F.length - 2, 2)
      }
      return k
    }

    function J(k) {
      k = k.replace(/rn/g, "n");
      var d = "";
      for (var F = 0; F < k.length; F++) {
        var x = k.charCodeAt(F);
        if (x < 128) {
          d += String.fromCharCode(x)
        } else {
          if ((x > 127) && (x < 2048)) {
            d += String.fromCharCode((x >> 6) | 192);
            d += String.fromCharCode((x & 63) | 128)
          } else {
            d += String.fromCharCode((x >> 12) | 224);
            d += String.fromCharCode(((x >> 6) & 63) | 128);
            d += String.fromCharCode((x & 63) | 128)
          }
        }
      }
      return d
    }
    var C = Array();
    var P, h, E, v, g, Y, X, W, V;
    var S = 7,
      Q = 12,
      N = 17,
      M = 22;
    var A = 5,
      z = 9,
      y = 14,
      w = 20;
    var o = 4,
      m = 11,
      l = 16,
      j = 23;
    var U = 6,
      T = 10,
      R = 15,
      O = 21;
    s = J(s);
    C = e(s);
    Y = 1732584193;
    X = 4023233417;
    W = 2562383102;
    V = 271733878;
    for (P = 0; P < C.length; P += 16) {
      h = Y;
      E = X;
      v = W;
      g = V;
      Y = u(Y, X, W, V, C[P + 0], S, 3614090360);
      V = u(V, Y, X, W, C[P + 1], Q, 3905402710);
      W = u(W, V, Y, X, C[P + 2], N, 606105819);
      X = u(X, W, V, Y, C[P + 3], M, 3250441966);
      Y = u(Y, X, W, V, C[P + 4], S, 4118548399);
      V = u(V, Y, X, W, C[P + 5], Q, 1200080426);
      W = u(W, V, Y, X, C[P + 6], N, 2821735955);
      X = u(X, W, V, Y, C[P + 7], M, 4249261313);
      Y = u(Y, X, W, V, C[P + 8], S, 1770035416);
      V = u(V, Y, X, W, C[P + 9], Q, 2336552879);
      W = u(W, V, Y, X, C[P + 10], N, 4294925233);
      X = u(X, W, V, Y, C[P + 11], M, 2304563134);
      Y = u(Y, X, W, V, C[P + 12], S, 1804603682);
      V = u(V, Y, X, W, C[P + 13], Q, 4254626195);
      W = u(W, V, Y, X, C[P + 14], N, 2792965006);
      X = u(X, W, V, Y, C[P + 15], M, 1236535329);
      Y = f(Y, X, W, V, C[P + 1], A, 4129170786);
      V = f(V, Y, X, W, C[P + 6], z, 3225465664);
      W = f(W, V, Y, X, C[P + 11], y, 643717713);
      X = f(X, W, V, Y, C[P + 0], w, 3921069994);
      Y = f(Y, X, W, V, C[P + 5], A, 3593408605);
      V = f(V, Y, X, W, C[P + 10], z, 38016083);
      W = f(W, V, Y, X, C[P + 15], y, 3634488961);
      X = f(X, W, V, Y, C[P + 4], w, 3889429448);
      Y = f(Y, X, W, V, C[P + 9], A, 568446438);
      V = f(V, Y, X, W, C[P + 14], z, 3275163606);
      W = f(W, V, Y, X, C[P + 3], y, 4107603335);
      X = f(X, W, V, Y, C[P + 8], w, 1163531501);
      Y = f(Y, X, W, V, C[P + 13], A, 2850285829);
      V = f(V, Y, X, W, C[P + 2], z, 4243563512);
      W = f(W, V, Y, X, C[P + 7], y, 1735328473);
      X = f(X, W, V, Y, C[P + 12], w, 2368359562);
      Y = D(Y, X, W, V, C[P + 5], o, 4294588738);
      V = D(V, Y, X, W, C[P + 8], m, 2272392833);
      W = D(W, V, Y, X, C[P + 11], l, 1839030562);
      X = D(X, W, V, Y, C[P + 14], j, 4259657740);
      Y = D(Y, X, W, V, C[P + 1], o, 2763975236);
      V = D(V, Y, X, W, C[P + 4], m, 1272893353);
      W = D(W, V, Y, X, C[P + 7], l, 4139469664);
      X = D(X, W, V, Y, C[P + 10], j, 3200236656);
      Y = D(Y, X, W, V, C[P + 13], o, 681279174);
      V = D(V, Y, X, W, C[P + 0], m, 3936430074);
      W = D(W, V, Y, X, C[P + 3], l, 3572445317);
      X = D(X, W, V, Y, C[P + 6], j, 76029189);
      Y = D(Y, X, W, V, C[P + 9], o, 3654602809);
      V = D(V, Y, X, W, C[P + 12], m, 3873151461);
      W = D(W, V, Y, X, C[P + 15], l, 530742520);
      X = D(X, W, V, Y, C[P + 2], j, 3299628645);
      Y = t(Y, X, W, V, C[P + 0], U, 4096336452);
      V = t(V, Y, X, W, C[P + 7], T, 1126891415);
      W = t(W, V, Y, X, C[P + 14], R, 2878612391);
      X = t(X, W, V, Y, C[P + 5], O, 4237533241);
      Y = t(Y, X, W, V, C[P + 12], U, 1700485571);
      V = t(V, Y, X, W, C[P + 3], T, 2399980690);
      W = t(W, V, Y, X, C[P + 10], R, 4293915773);
      X = t(X, W, V, Y, C[P + 1], O, 2240044497);
      Y = t(Y, X, W, V, C[P + 8], U, 1873313359);
      V = t(V, Y, X, W, C[P + 15], T, 4264355552);
      W = t(W, V, Y, X, C[P + 6], R, 2734768916);
      X = t(X, W, V, Y, C[P + 13], O, 1309151649);
      Y = t(Y, X, W, V, C[P + 4], U, 4149444226);
      V = t(V, Y, X, W, C[P + 11], T, 3174756917);
      W = t(W, V, Y, X, C[P + 2], R, 718787259);
      X = t(X, W, V, Y, C[P + 9], O, 3951481745);
      Y = K(Y, h);
      X = K(X, E);
      W = K(W, v);
      V = K(V, g)
    }
    var i = B(Y) + B(X) + B(W) + B(V);
    return i.toLowerCase()
  },
  showOldComments: function(postId) {
    var comments = OldComments.GetComments(postId);
    $('#old_comments_head').remove();
    $('#old_comments_line').remove();
    $("[comments-count]").text(comments.length);
    comments = comments.sort(function(a, b) {
      return a.timestamp - b.timestamp;
    });
    if (comments.length > 0) {
      var old_head = $("<div></div>")
        .attr('id', "old_comments_head")
        .addClass("panel-heading")
        .attr('role', "tab")
        .append($("<a></a>")
          .attr('role', "button")
          .attr('data-toggle', "collapse")
          .attr('data-parent', "#comments")
          .attr('href', "#old_comments")
          .attr('aria-expanded', "true")
          .attr('aria-controls', "old_comments")
          .attr('style', "border-top: '1px solid';border-top-left-radius: 0;border-top-right-radius: 0")
          .append($("<strong></strong>")
            .text("旧评论")
          )
        );
      var old_comments_line = $("<div></div>")
        .attr('id', "old_comments")
        .addClass("list-group")
        .addClass('panel-collapse')
        .addClass('collapse')
        .attr('role', "tabpanel")
        .attr('aria-labelledby', "old_comments_head");
      var old_comments_count = $("<div></div>")
        .attr('id', "old_comments_count")
        .addClass("list-group-item")
        .css({border-bottom: "0px"})
        .append($("<strong>&nbsp</strong>"));      
      $("#comments").append(old_head);
      //old_head.insertBefore($("#git_comments"));
      $("#comments").append(old_comments_line);
      //old_comments_line.insertBefore($("#git_comments"));
      $("#comments").append(old_comments_count);
    }
    for (var i = comments.length - 1;i >=0;i--){
      OldComments.addOldComment(comments[i]);
    }
  },
  addOldComment: function(comment) {
    var commentId = comment.id;
    var userName = comment.name;
    var userAvatar = OldComments.getGravatar(comment.email, 20);
    var userLink = comment.url;
    var date = new Date(comment.timestamp);

    var comment_detail = $("<div></div>");
    comment_detail.append(
      $("<div></div>").attr('id', 'comment_text_' + commentId).addClass('page_blog_comment_message')
    );
    var name_div = $("<div></div>");
    name_div.append("<img class='img-circle' style='width: 20px;height: 20px;' alt='" + userName + "' src='" + userAvatar + "' />").append(" ");
    name_div.append($("<span></span>").addClass("page_blog_comment_name").text(userName)).append(" ");
    name_div.append(
      $("<span></span>")
      .addClass("page_datetime")
      .text(timeSince(date))
      .attr("title",formatDate(date))
     );
    if (userLink) {
      name_div.append(" ").append(
        $("<a></a>").attr("href", userLink).attr("target", "_blank").append(
          $("<button></button>").addClass("btn btn-link").append(
            $("<span></span>").addClass("glyphicon glyphicon-home")
          )
        )
      );
    }
    var d_comments = $("<div></div>").addClass("list-group-item").attr('id', "old_comments_" + commentId).append(name_div).append(comment_detail);
    $("#old_comments").append(d_comments);
    $('#comment_text_' + commentId).append($("<p></p>").text(comment.comment));
  },
}
