<div class="panel panel-default">
  <div id="comments" class="list-group">
    <div class="list-group-item">
      以下正在测试，请无视_(:зゝ∠)_
    </div>
    <div class="list-group-item">
      <form class="form-horizontal">
        <div class="form-group">
          <label class="col-sm-2 control-label" for="name">*昵称</label>
          <div class="col-sm-10">
            <input id="name" type="text" class="form-control" name="name" required>
          </div>
        </div>
        <input id="reply" type="hidden" value="" />
        <div class="form-group">
          <label class="col-sm-2 control-label" for="email">*电子邮件</label>
          <div class="col-sm-10">
            <input id="email" type="email" class="form-control" name="email" required>
          </div>
        </div>
        <div class="form-group">
          <label class="col-sm-2 control-label" for="url">网站</label>
          <div class="col-sm-10">
            <input id="url" type="url" class="form-control" name="url">
          </div>
        </div>
        <div id="reply_to" style="display:none;" class="form-group">
          <label class="col-sm-2 control-label" for="reply_input">回复</label>
          <div class="col-sm-10">
            <span id="reply_user"></span><button id="reply_clear" title="清除" type="button" class="btn btn-link"><span class="glyphicon glyphicon-remove"></span></button>
          </div>
        </div>
        <div class="form-group">
          <label class="col-sm-2 control-label" for="comment">*评论</label>
          <div class="col-sm-10">
            <textarea id="comment" class="form-control" name="comment" required></textarea>
          </div>
        </div>
        <div class="text-center">
          <button id="add_comment" class="btn btn-default">评论</button>
          <button type="reset" class="btn btn-default">重置</button>
        </div>
      </form>
    </div>
    <div id="div_comments" class="list-group-item">
      评论共<span id="comment_count"></span>条
      <script type="text/javascript">
        Comments.post.commentCount.updateCallback("{{ page.id }}", function(count){
          document.getElementById('comment_count').innerHTML = count;
        })
      </script>
    </div>
  </div>
</div>

<!-- Modal -->
<div class="modal fade" id="modal_error" tabindex="-1" role="dialog" aria-labelledby="errorModalLabel">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="errorModalLabel">Error</h4>
      </div>
      <div id="error_message" class="modal-body">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<script src="{{ site.baseurl }}/js/avatar.js"></script>
<script type="text/javascript">
  var comments_messages = undefined; 
  function showError(error) {
    var message = error.message? error.message:error;
    $("#modal_error").modal('show');
    $("#error_message").text(message);
  }

  Comments.handleError = function(error) {
    showError(error);
  };

  Comments.comment.listCallback("{{ page.id }}", function(messages) {
    comments_messages = messages
    $('div[id^=comments_]').remove();
    for (commentId in messages) {
      var comment = messages[commentId];
      var comment_detail = $("<div></div>");
      if (comment.reply) {
        comment_detail.append(
          $("<blockquote></blockquote>").append(
            $("<div></div>").append(
              $("<img></img>").addClass("img-circle").attr("alt", messages[comment.reply].name).attr('src', getGravatar(messages[comment.reply].email, 20))
            ).append(" ").append(
              $("<strong></strong>").text(messages[comment.reply].name)
            ).append(" ").append(
              $("<span></span>").addClass('page_datetime').text(Comments.formatDate(new Date(parseInt(messages[comment.reply].timestamp))))
            ).append(
              $("<pre></pre>").text(messages[comment.reply].comment)
            )
          )
        )
      }
      comment_detail.append(
        $("<pre></pre>").text(comment.comment)
      );
      var name_div = $("<div></div>").append(
        $("<img></img>").addClass("img-circle").attr("alt", comment.name).attr('src', getGravatar(comment.email, 20))
      ).append(" ").append(
        $("<strong></strong>").text(comment.name)
      ).append(" ").append(
        $("<span></span>").addClass('page_datetime').text(Comments.formatDate(new Date(parseInt(comment.timestamp))))
      );

      if (comment.url) {
        name_div.append(" ").append(
          $("<a></a>").attr('href', 'comment.url').attr('title', "网站").append(
            $("<button></button>").addClass('btn btn-link').append(
              $("<span></span>").addClass("glyphicon glyphicon-home")
            )
          )
        );
      }

      name_div.append(" ").append(
        $("<button></button>").addClass('btn btn-link').attr('title', "回复").attr('id',"button_reply_" + commentId).attr('reply', commentId).append(
            $("<span></span>").addClass("glyphicon glyphicon-comment")
          )
      );

      var d_comments = $("<div></div>").addClass("list-group-item").attr('id',"comments_" + commentId).append(name_div).append(comment_detail);
      d_comments.insertAfter($("#div_comments"));
    }

    $("button[id^=button_reply_]").click(function(){
      var reply = $(this).attr("reply");
      $("#reply").val(reply);
      $("#reply_user").text(comments_messages[reply].name);
      $("#reply_to").show();
    });
  });

  $("#add_comment").click(function(){
    $("#add_comment").attr("disabled", "");
    Comments.comment.add($("#name").val(), $("#email").val(), '{{ page.id }}', $("#comment").val(), $("#url").val(), $("#reply").val(),  function(result){
        if (result) {
          $("#comment").val("");
        }

        $("#add_comment").removeAttr("disabled");
    });
  });

  $("#reply_clear").click(function() {
    $("#reply").val("");
    $("#reply_to").hide();
  });
</script>